<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sentinel Cloud Vision | Nova Noir</title>
    <link rel="stylesheet" href="theme.css">
    <style>
        .dashboard-grid {
            display: grid;
            grid-template-columns: 250px 1fr 300px;
            gap: 1rem;
            padding: 1rem;
            height: 100vh;
        }

        .stream-view {
            background: #000;
            border: 1px solid var(--primary-red);
            position: relative;
            overflow: hidden;
        }

        .stream-overlay {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.7);
            padding: 5px;
            border-left: 2px solid var(--primary-red);
        }

        .nova-card1 {
            height: 100%;
            width: 100%;
            font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            font-weight: bold;
            font-size: 15px;
            align-items: center;
            background-image: linear-gradient(144deg, #680202, #410a0a 50%, #000000);
            border-radius: 1px;
            border: 1px solid var(--primary-red);
            box-shadow: rgba(0, 3, 24, 0.2) 0 1px 30px -5px;
            box-sizing: border-box;
            color: #8f7f7f;
            display: flex;
            justify-content: center;
            line-height: 1em;
            min-width: 10px;
            padding: 1px;
            text-decoration: none;
            user-select: none;
            -webkit-user-select: none;
            touch-action: manipulation;
            white-space: nowrap;
            cursor: pointer;
        }

        .nova-card1:active,
        .nova-card1:hover {
            outline: 0;
        }

        .nova-card1 span {
            align-items: center;
            justify-content: center;
            background-color: rgba(255, 0, 0, 0.315);
            padding: 1px 2px;
            border-radius: 1px;
            width: 100%;
            height: 100%;
            transition: 300ms;
        }

        .nova-card1:hover span {
            background: none;
        }

        .model-list {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%;
        }
    </style>
</head>

<body>
    <div class="dashboard-grid">
        <!-- Sidebar: Models (Left) -->

        <div style="display: flex; flex-direction: column; gap: 1rem;">
            <div style="text-align: center; font-size: 1.5rem; font-weight: bold; color: var(--primary-red);">
                Sentinel Cloud Vision
            </div>
            <div style="padding: 0 1rem;">
                <input type="text" id="model-search" placeholder="Search models..."
                    style="width: 100%; background: #000; color: #fff; border: 1px solid var(--primary-red); padding: 5px; box-sizing: border-box;">
            </div>
            <div class="nova-card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                    <h3 style="color: var(--primary-red); margin: 0;">MODELS</h3>
                    <div id="conn-status"
                        style="display: flex; align-items: center; gap: 5px; font-size: 0.6rem; color: #ff0000;">
                        <span id="conn-light"
                            style="width: 8px; height: 8px; border-radius: 50%; background: #ff0000;"></span>
                        OFFLINE
                    </div>
                </div>
                <div id="model-list" class="model-list">
                    <button class="nova-card1" role="button" style="margin-bottom: 0.5rem; cursor: pointer;">
                        <span>ResNet-18 (Active)</span>
                    </button>
                    <button class="nova-card1" role="button" style="margin-bottom: 0.5rem; cursor: pointer;">
                        <span>ResNet-50 (Active)</span>
                    </button>
                    <button class="nova-card1" role="button" style="margin-bottom: 0.5rem; opacity: 0.5;">
                        <span>YOLOv8 (Restricted)</span>
                    </button>
                    <button id="start-object-detection-btn" class="nova-card1" role="button"
                        style="margin-bottom: 0.5rem; color: white; border-radius: 3px; width: auto; cursor: pointer;">
                        <span>Start Capturing</span>
                    </button>
                </div>
            </div>

            <div class="nova-card">
                <h3 style="color: var(--primary-red); margin-bottom: 0.5rem;">TCN MODELS</h3>
                <div id="model-list-tcn" class="model-list">
                    <button class="nova-card1" role="button" style="margin-bottom: 0.5rem; cursor: pointer;">
                        <span>TCN-Segmenter (Active)</span>
                    </button>
                    <button class="nova-card1" role="button" style="margin-bottom: 0.5rem; opacity: 0.5;">
                        <span>TCN-Sequence (Restricted)</span>
                    </button>
                    <button id="start-tcn-btn" class="nova-card1" role="button"
                        style="margin-bottom: 0.5rem; color: white; border-radius: 7px; width: auto; cursor: pointer;">
                        <span>Start Capturing</span>
                    </button>
                </div>
            </div>

            <div class="nova-card">
                <h3 style="color: var(--primary-red); margin-bottom: 0.5rem;">MODELS for dialogue</h3>
                <div id="model-list-dialogue" class="model-list">
                    <button class="nova-card1" role="button" style="margin-bottom: 0.5rem; cursor: pointer;">
                        <span class="text">BERT (Active)</span>
                    </button>
                    <button class="nova-card1" role="button" style="margin-bottom: 0.5rem; opacity: 0.5;">
                        <span>ViL-BERT (Restricted)</span>
                    </button>
                    <button class="nova-card1" role="button" style="margin-bottom: 0.5rem; opacity: 0.5;">
                        <span>GPT (Restricted)</span>
                    </button>
                    <button id="start-dialogue-btn" class="nova-card1" role="button"
                        style="margin-bottom: 0.5rem; color: white;border-radius: 7px; width: auto; cursor: pointer;">
                        <span>Start Capturing</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- Main Stream View (Center) -->
        <main class="stream-view">
            <div id="stream-overlay" class="stream-overlay" style="display: none;">
                LIVE FEED: HD-STREAM-01 <br>
                <span style="color: var(--primary-red)">‚óè RECORDING</span>
            </div>
            <!-- Canvas/Video for stream -->
            <div id="stream-container"
                style="display: flex; flex-direction: column; justify-content: center; align-items: center; height: 100%;">
                <!-- Canvas for bounding boxes -->
                <canvas id="detection-canvas"
                    style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 10;"></canvas>
                <video id="webcam-feed" autoplay playsinline
                    style="max-width: 100%; max-height: 80%; display: none; border: 2px solid var(--primary-red); position: relative; z-index: 1;"></video>
                <button id="start-camera-btn"
                    style="background: var(--primary-red); color: #fff; border: none; padding: 10px 20px; cursor: pointer; font-size: 1rem; font-weight: bold; border-radius: 5px; z-index: 20;">
                    START CAMERA
                </button>
                <button id="stop-camera-btn"
                    style="background: #333; color: #fff; border: none; padding: 10px 20px; cursor: pointer; font-size: 1rem; font-weight: bold; display: none; border-radius: 5px;">
                    STOP CAMERA
                </button>
                <p id="camera-status"
                    style="color: var(--text-secondary); font-family: 'Courier New', Courier, monospace; font-size: 0.75rem;">
                    [ CAMERA INACTIVE ]</p>
                <button id="select-file-btn"
                    style="background: var(--primary-red); color: #fff; border: none; padding: 10px 20px; cursor: pointer; font-size: 1rem; font-weight: bold; border-radius: 5px;">
                    SELECT FILE
                </button>
                <button id="connect-edge-btn"
                    style="background: var(--primary-red); color: #fff; border: none; padding: 10px 20px; cursor: pointer; font-size: 1rem; font-weight: bold; border-radius: 5px; margin-top: 20px;">
                    CONNECT TO EDGE DEVICE
                </button>
                <button id="connect-phone-btn"
                    style="background: var(--primary-red); color: #fff; border: none; padding: 10px 20px; cursor: pointer; font-size: 1rem; font-weight: bold; border-radius: 5px; margin-top: 20px;">
                    CONNECT TO PHONE CAMERA
                </button>
                <input type="file" id="file-input" accept="video/*" style="display: none;">
            </div>
        </main>

        <!-- Sidebar: Real-time Alerts & Video Generator (Right) -->
        <section class="nova-card" style="display: flex; flex-direction: column;">
            <div>
                <div style="display: flex; gap: 1rem;">
                    <button class="nova-card1"
                        style="margin-bottom: 0.5rem; color: white; border-radius: 3px; width: auto; cursor: pointer;">Login</button>
                    <button class="nova-card1"
                        style="margin-bottom: 0.5rem; color: white; border-radius: 3px; width: auto; cursor: pointer;">Sign
                        up</button>
                </div>
            </div>
            <h3 style="color: var(--primary-red)">ALERTS</h3>
            <div>
                <h3 style="color: var(--primary-red)">VIDEO GENERATOR</h3>
                <textarea id="video-prompt" placeholder="Enter prompt..."
                    style="width: 100%; background: #000; color: #fff; border: 1px solid var(--primary-red); padding: 5px; margin-bottom: 5px;"></textarea>
                <button id="generate-video-btn"
                    style="width: 100%; background: var(--primary-red); color: #fff; border: none; padding: 5px; cursor: pointer;">GENERATE</button>
                <div id="video-result" style="margin-top: 10px; display: none;">
                    <video id="output-video" width="100%" controls style="border: 1px solid var(--primary-red);">
                        Your browser does not support the video tag.
                    </video>
                    <p id="generating-status" style="color: var(--primary-red); font-size: 0.8rem; display: none;">
                        GENERATING...</p>
                </div>
            </div>
        </section>
    </div>

    <script>
        // Model Search Functionality
        document.getElementById('model-search').addEventListener('input', function (e) {
            const searchTerm = e.target.value.toLowerCase();
            const modelButtons = document.querySelectorAll('.model-list .nova-card1');

            modelButtons.forEach(btn => {
                const text = btn.querySelector('span').textContent.toLowerCase();
                if (text.includes(searchTerm)) {
                    btn.style.display = 'flex';
                } else {
                    btn.style.display = 'none';
                }
            });
        });

        // Camera activation
        const startCameraBtn = document.getElementById('start-camera-btn');
        const stopCameraBtn = document.getElementById('stop-camera-btn');
        const selectFileBtn = document.getElementById('select-file-btn');
        const connectEdgeBtn = document.getElementById('connect-edge-btn');
        const connectPhoneBtn = document.getElementById('connect-phone-btn');
        const fileInput = document.getElementById('file-input');
        const webcamFeed = document.getElementById('webcam-feed');
        const cameraStatus = document.getElementById('camera-status');
        const streamOverlay = document.getElementById('stream-overlay');
        const alertFeed = document.getElementById('alert-feed');
        const startObjectDetectionBtn = document.getElementById('start-object-detection-btn');
        const startTcnBtn = document.getElementById('start-tcn-btn');
        const startDialogueBtn = document.getElementById('start-dialogue-btn');
        const detectionCanvas = document.getElementById('detection-canvas');
        const ctx = detectionCanvas.getContext('2d');
        let detectionInterval = null;

        let currentStream = null;

        // QR Code Modal
        const modal = document.createElement('div');
        modal.style.display = 'none';
        modal.style.position = 'fixed';
        modal.style.top = '0';
        modal.style.left = '0';
        modal.style.width = '100%';
        modal.style.height = '100%';
        modal.style.background = 'rgba(0,0,0,0.8)';
        modal.style.zIndex = '1000';
        modal.style.justifyContent = 'center';
        modal.style.alignItems = 'center';
        modal.style.flexDirection = 'column';
        modal.id = 'qr-modal';

        modal.innerHTML = `
            <div class="nova-card" style="padding: 2rem; align-items: center; justify-content: center; display: flex; flex-direction: column;">
                <h2 style="color: var(--primary-red); margin-bottom: 1rem;">SCAN TO CONNECT</h2>
                <img id="qr-image" src="" style="width: 250px; height: 250px; border: 2px solid var(--primary-red); margin-bottom: 1rem;">
                <p style="text-align: center; color: #fff; margin-bottom: 1rem;">Scan with your mobile camera<br>to start streaming.</p>
                <button id="close-modal-btn" style="background: var(--primary-red); color: white; border: none; padding: 10px 20px; font-weight: bold; cursor: pointer;">CLOSE</button>
            </div>
        `;
        document.body.appendChild(modal);

        document.getElementById('close-modal-btn').addEventListener('click', () => {
            modal.style.display = 'none';
        });

        connectPhoneBtn.addEventListener('click', async () => {
            try {
                const res = await fetch('http://localhost:8001/qr-code');
                if (res.ok) {
                    const blob = await res.blob();
                    document.getElementById('qr-image').src = URL.createObjectURL(blob);
                    modal.style.display = 'flex';
                }
            } catch (error) {
                console.error("Error fetching QR code:", error);
                alert("Failed to connect to backend for QR Code.");
            }
        });
        startObjectDetectionBtn.addEventListener('click', toggleCamera);
        stopCameraBtn.addEventListener('click', stopCamera);

        async function toggleCamera() {
            if (currentStream) {
                stopCamera();
            } else {
                startCamera();
            }
        }

        async function startCamera() {
            try {
                cameraStatus.textContent = '[ REQUESTING CAMERA ACCESS... ]';
                cameraStatus.style.color = 'var(--primary-red)';

                currentStream = await navigator.mediaDevices.getUserMedia({
                    video: { width: 1280, height: 720 },
                    audio: false
                });

                webcamFeed.srcObject = currentStream;
                webcamFeed.style.display = 'block';
                startCameraBtn.style.display = 'none';
                stopCameraBtn.style.display = 'block';

                // Update Start Capturing button to Stop Capturing
                const btnSpan = startObjectDetectionBtn.querySelector('span');
                if (btnSpan) btnSpan.textContent = "Stop Capturing";
                startObjectDetectionBtn.style.backgroundColor = "#333";

                streamOverlay.style.display = 'block';
                cameraStatus.textContent = '[ CAMERA ACTIVE ]';
                cameraStatus.style.color = '#00ff00';

                // Resize canvas to match video
                webcamFeed.onloadedmetadata = () => {
                    detectionCanvas.width = webcamFeed.videoWidth;
                    detectionCanvas.height = webcamFeed.videoHeight;
                    // Adjust canvas style size to match the displayed video size
                    detectionCanvas.style.width = webcamFeed.clientWidth + 'px';
                    detectionCanvas.style.height = webcamFeed.clientHeight + 'px';
                };

                // Start polling vision module
                detectionInterval = setInterval(async () => {
                    try {
                        const res = await fetch('http://localhost:8001/detect');
                        const data = await res.json();

                        if (data.detections) {
                            // Clear previous drawings
                            ctx.clearRect(0, 0, detectionCanvas.width, detectionCanvas.height);

                            // Re-scale canvas if video size changed (simple check)
                            if (webcamFeed.videoWidth > 0 && (detectionCanvas.width !== webcamFeed.videoWidth || detectionCanvas.height !== webcamFeed.videoHeight)) {
                                detectionCanvas.width = webcamFeed.videoWidth;
                                detectionCanvas.height = webcamFeed.videoHeight;
                            }

                            if (data.detections.length > 0) {
                                const latestAlert = document.createElement('div');
                                latestAlert.className = 'nova-card';
                                latestAlert.style.marginBottom = '0.5rem';
                                latestAlert.style.fontSize = '0.8rem';
                                latestAlert.innerHTML = `<strong>${data.timestamp}</strong><br>` +
                                    data.detections.map(d => `${d.label}: ${(d.score * 100).toFixed(0)}%`).join('<br>');
                                alertFeed.prepend(latestAlert);

                                // Keep only last 5 alerts
                                while (alertFeed.children.length > 5) {
                                    alertFeed.removeChild(alertFeed.lastChild);
                                }

                                // Draw boxes
                                data.detections.forEach(d => {
                                    if (d.box && d.box.length === 4) {
                                        const [x1, y1, x2, y2] = d.box;
                                        ctx.strokeStyle = '#ff0000';
                                        ctx.lineWidth = 3;
                                        ctx.strokeRect(x1, y1, x2 - x1, y2 - y1);

                                        ctx.font = '16px Arial';
                                        ctx.fillStyle = '#ff0000';
                                        ctx.fillText(`${d.label} ${(d.score * 100).toFixed(0)}%`, x1, y1 - 5);
                                    }
                                });
                            }
                        }
                    } catch (err) {
                        console.error('Vision module error:', err);
                    }
                }, 100); // Fast Poll for smoother UI
            } catch (error) {
                console.error('Camera access error:', error);
                cameraStatus.textContent = '[ CAMERA ACCESS DENIED ]';
                cameraStatus.style.color = '#ff0000';
            }
        }

        selectFileBtn.addEventListener('click', () => {
            fileInput.click();
        });

        fileInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (file) {
                // Stop camera if active
                if (currentStream) {
                    currentStream.getTracks().forEach(track => track.stop());
                    currentStream = null;
                }
                if (detectionInterval) {
                    clearInterval(detectionInterval);
                    detectionInterval = null;
                }

                const fileURL = URL.createObjectURL(file);
                webcamFeed.srcObject = null;
                webcamFeed.src = fileURL;
                webcamFeed.style.display = 'block';
                webcamFeed.loop = true; // Auto loop for files
                webcamFeed.play();

                startCameraBtn.style.display = 'block';
                stopCameraBtn.style.display = 'none';
                streamOverlay.style.display = 'block';
                cameraStatus.textContent = `[ FILE: ${file.name} ]`;
                cameraStatus.style.color = '#00ff00';
            }
        });

        // Connection heartbeat
        const connLight = document.getElementById('conn-light');
        const connText = document.getElementById('conn-status');

        setInterval(async () => {
            try {
                const res = await fetch('http://localhost:8001/', { method: 'GET' });
                if (res.ok) {
                    connLight.style.background = '#00ff00';
                    connLight.style.boxShadow = '0 0 5px #00ff00';
                    connText.childNodes[2].textContent = ' ONLINE';
                    connText.style.color = '#00ff00';
                } else {
                    throw new Error();
                }
            } catch (e) {
                connLight.style.background = '#ff0000';
                connLight.style.boxShadow = 'none';
                connText.childNodes[2].textContent = ' OFFLINE';
                connText.style.color = '#ff0000';
            }
        }, 3000);

        function stopCamera() {
            if (currentStream) {
                currentStream.getTracks().forEach(track => track.stop());
                currentStream = null;
            }
            if (detectionInterval) {
                clearInterval(detectionInterval);
                detectionInterval = null;
            }
            webcamFeed.srcObject = null;
            webcamFeed.style.display = 'none';
            stopCameraBtn.style.display = 'none';

            // Reset Start Capturing button
            const btnSpan = startObjectDetectionBtn.querySelector('span');
            if (btnSpan) btnSpan.textContent = "Start Capturing";
            startObjectDetectionBtn.style.backgroundColor = ""; // Reset to CSS default

            streamOverlay.style.display = 'none';
            startCameraBtn.style.display = 'block';
            cameraStatus.textContent = '[ CAMERA INACTIVE ]';
            cameraStatus.style.color = 'var(--text-secondary)';

            // Clear canvas
            ctx.clearRect(0, 0, detectionCanvas.width, detectionCanvas.height);
        }

        // Video generator
        document.getElementById('generate-video-btn').addEventListener('click', async () => {
            const prompt = document.getElementById('video-prompt').value;
            if (!prompt) return;

            const btn = document.getElementById('generate-video-btn');
            const resultDiv = document.getElementById('video-result');
            const videoElement = document.getElementById('output-video');
            const statusLabel = document.getElementById('generating-status');

            btn.disabled = true;
            resultDiv.style.display = 'block';
            videoElement.style.display = 'none';
            statusLabel.style.display = 'block';

            try {
                const response = await fetch('http://localhost:8000/generate-video', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ prompt: prompt })
                });

                if (!response.ok) throw new Error('Generation failed');

                const blob = await response.blob();
                const videoUrl = URL.createObjectURL(blob);

                videoElement.src = videoUrl;
                videoElement.style.display = 'block';
                statusLabel.style.display = 'none';
                videoElement.play();
            } catch (error) {
                console.error(error);
                statusLabel.innerText = 'ERROR';
            } finally {
                btn.disabled = false;
            }
        });
    </script>
</body>

</html>